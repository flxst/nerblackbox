
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../data/">
      
      
        <link rel="next" href="../evaluation/">
      
      <link rel="icon" href="../images/package-16.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.1">
    
    
      
        <title>Training - nerblackbox</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.402914a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#training" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="nerblackbox" class="md-header__button md-logo" aria-label="nerblackbox" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m8.878.392 5.25 3.045c.54.314.872.89.872 1.514v6.098a1.75 1.75 0 0 1-.872 1.514l-5.25 3.045a1.75 1.75 0 0 1-1.756 0l-5.25-3.045A1.75 1.75 0 0 1 1 11.049V4.951c0-.624.332-1.201.872-1.514L7.122.392a1.75 1.75 0 0 1 1.756 0ZM7.875 1.69l-4.63 2.685L8 7.133l4.755-2.758-4.63-2.685a.248.248 0 0 0-.25 0ZM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432Zm6.25 8.271 4.625-2.683a.25.25 0 0 0 .125-.216V5.677L8.75 8.432Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            nerblackbox
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Training
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Start
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../preparation/" class="md-tabs__link">
      Preparation
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../data/" class="md-tabs__link">
      Data
    </a>
  </li>

      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      Training
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../evaluation/" class="md-tabs__link">
      Evaluation
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../inference/" class="md-tabs__link">
      Inference
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../advanced/compatibility_with_huggingface/" class="md-tabs__link">
        Advanced
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../python_api/overview/" class="md-tabs__link">
        Python API
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../cli/" class="md-tabs__link">
      CLI
    </a>
  </li>

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="nerblackbox" class="md-nav__button md-logo" aria-label="nerblackbox" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m8.878.392 5.25 3.045c.54.314.872.89.872 1.514v6.098a1.75 1.75 0 0 1-.872 1.514l-5.25 3.045a1.75 1.75 0 0 1-1.756 0l-5.25-3.045A1.75 1.75 0 0 1 1 11.049V4.951c0-.624.332-1.201.872-1.514L7.122.392a1.75 1.75 0 0 1 1.756 0ZM7.875 1.69l-4.63 2.685L8 7.133l4.755-2.758-4.63-2.685a.248.248 0 0 0-.25 0ZM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432Zm6.25 8.271 4.625-2.683a.25.25 0 0 0 .125-.216V5.677L8.75 8.432Z"/></svg>

    </a>
    nerblackbox
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Start
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../preparation/" class="md-nav__link">
        Preparation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        Data
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Training
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Training
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#model-sources" class="md-nav__link">
    Model Sources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic-training" class="md-nav__link">
    Basic Training
  </a>
  
    <nav class="md-nav" aria-label="Basic Training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-an-experiment" class="md-nav__link">
    Define an Experiment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-an-experiment" class="md-nav__link">
    Run an Experiment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main-results" class="md-nav__link">
    Main Results
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-training" class="md-nav__link">
    Advanced Training
  </a>
  
    <nav class="md-nav" aria-label="Advanced Training">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#presets" class="md-nav__link">
    Presets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyperparameter-search" class="md-nav__link">
    Hyperparameter Search
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-seeds" class="md-nav__link">
    Multiple Seeds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detailed-results" class="md-nav__link">
    Detailed Results
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/" class="md-nav__link">
        Evaluation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../inference/" class="md-nav__link">
        Inference
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Advanced
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Advanced
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/compatibility_with_huggingface/" class="md-nav__link">
        Compatibility with HuggingFace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/text_encoding/" class="md-nav__link">
        Text Encoding
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Python API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Python API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python_api/overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python_api/store/" class="md-nav__link">
        Store
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python_api/dataset/" class="md-nav__link">
        Dataset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python_api/experiment/" class="md-nav__link">
        Experiment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python_api/model/" class="md-nav__link">
        Model
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python_api/annotation_tool/" class="md-nav__link">
        AnnotationTool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../python_api/text_encoder/" class="md-nav__link">
        TextEncoder
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        CLI
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="training">Training</h1>
<p>Given a dataset that is properly <a href="../data">set up</a>, we can fine-tune a pretrained model for Named Entity Recognition.</p>
<hr />
<h2 id="model-sources">Model Sources</h2>
<p><strong>nerblackbox</strong> works with PyTorch transformer models only. 
They can either be taken straight from HuggingFace (HF) or the Local Filesystem (LF).
In order to employ models from HF, it is sufficient to specify the name of the model (see <a href="#basic-training">Basic Training</a>).</p>
<p>Local models need to be stored in a directory <code>./store/pretrained_models/&lt;my_model&gt;</code> and include the following files:</p>
<ul>
<li><code>config.json</code></li>
<li><code>pytorch_model.bin</code></li>
<li><code>vocab.txt</code></li>
</ul>
<p>Note that the name for <code>&lt;my_model&gt;</code> must include the architecture type, e.g. <code>bert</code>.</p>
<hr />
<h2 id="basic-training">Basic Training</h2>
<p>Fine-tuning a <strong>specific model</strong> on a <strong>specific dataset</strong> using <strong>specific parameters</strong> is called an <strong>experiment</strong>. 
An experiment is handled by the <a href="../../python_api/experiment">Experiment</a> class.</p>
<hr />
<h3 id="define-an-experiment">Define an Experiment</h3>
<p>An experiment is defined </p>
<ul>
<li>
<p>either <strong>dynamically</strong> through arguments when an <a href="../../python_api/experiment/">Experiment</a> instance is created</p>
<details class="note">
<summary>define experiment dynamically</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="s2">&quot;&lt;experiment_name&gt;&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;&lt;model_name&gt;&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;&lt;dataset_name&gt;&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
</li>
<li>
<p>or <strong>statically</strong> by an <strong>experiment configuration</strong> file <code>./store/experiment_configs/&lt;experiment_name&gt;.ini</code>.</p>
<details class="note">
<summary>define experiment statically</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="s2">&quot;&lt;experiment_name&gt;&quot;</span><span class="p">,</span> <span class="n">from_config</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
</li>
</ul>
<p>Note that the dynamic variant also creates an experiment configuration, which is subsequently used.
In both cases, the specification of the <code>model</code> and the <code>dataset</code> are mandatory and sufficient.
Training <a href="#parameters">Parameters</a> may be specified but are optional. The hyperparameters that are used by default are globally applicable settings that should give close-to-optimal results for any use case.
In particular, <a href="#presets">adaptive fine-tuning</a> is employed to ensure that this holds irrespective of the size of the dataset.  </p>
<hr />
<h3 id="run-an-experiment">Run an Experiment</h3>
<p>A fine-tuning experiment is run using the following command:</p>
<details class="note">
<summary>run experiment</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">experiment</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<p>See the <a href="../../python_api/experiment/#nerblackbox.api.experiment.Experiment.run">Python API documentation</a> for further details.</p>
<hr />
<h3 id="main-results">Main Results</h3>
<p>When an experiment is finished, one can get its main results like so:</p>
<details class="note">
<summary>Main Results (single experiment)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">experiment</span><span class="o">.</span><span class="n">get_result</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<p>See <a href="../../python_api/experiment/#nerblackbox.api.experiment.Experiment.get_result">Python API documentation</a> for further details.</p>
<p>An overview of all conducted experiments and their main results can be accessed using the <a href="../python_api/store">Store</a> class:</p>
<details class="note">
<summary>Main Results (all experiments)</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">Store</span><span class="o">.</span><span class="n">show_experiments</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<hr />
<h3 id="example">Example</h3>
<p>An English BERT model can be fine-tuned on the CoNLL-2003 dataset like this:</p>
<details class="example">
<summary>Example: Training</summary>
<div class="highlight"><pre><span></span><code><span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="s2">&quot;my_experiment&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;bert-base-cased&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;conll2003&quot;</span><span class="p">)</span> 
<span class="n">experiment</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>                                                                       
<span class="n">experiment</span><span class="o">.</span><span class="n">get_result</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>                       
<span class="c1"># 0.9045</span>
</code></pre></div>
</details>
<hr />
<h2 id="advanced-training">Advanced Training</h2>
<h3 id="parameters">Parameters</h3>
<p><strong>nerblackbox</strong> uses a large amount of default (hyper)parameters that can be customized as needed. 
The concerned parameters just need to be specified when <a href="#define-an-experiment">an experiment is defined</a>, 
either statically or dynamically.</p>
<ul>
<li>
<p>In the <strong>static</strong> case, an experiment configuration file may look like this:</p>
<details class="example">
<summary>Example: static experiment configuration file with parameters</summary>
<div class="highlight"><pre><span></span><code><span class="gh"># my_experiment.ini</span>

[dataset]
dataset_name = swedish_ner_corpus
annotation_scheme = plain
prune_ratio_train = 0.1  # for testing
prune_ratio_val = 1.0
prune_ratio_test = 1.0
train_on_val = False
train_on_test = False

[model]
pretrained_model_name = af-ai-center/bert-base-swedish-uncased

[settings]
checkpoints = True
logging_level = info
multiple_runs = 1
seed = 42

[hparams]
max_epochs = 250
early_stopping = True
monitor = val_loss
min_delta = 0.0
patience = 0
mode = min
lr_warmup_epochs = 2
lr_num_cycles = 4
lr_cooldown_restarts = True
lr_cooldown_epochs = 7

[runA]
batch_size = 16
max_seq_length = 128
lr_max = 2e-5
lr_schedule = constant
</code></pre></div>
</details>
</li>
<li>
<p>In the <strong>dynamic</strong> case, the equivalent example is:</p>
<details class="example">
<summary>Example: dynamic experiment with parameters</summary>
<div class="highlight"><pre><span></span><code><span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span>
    <span class="s2">&quot;my_experiment&quot;</span><span class="p">,</span> 
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;af-ai-center/bert-base-swedish-uncased&quot;</span><span class="p">,</span>  <span class="c1"># model = model_name</span>
    <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;swedish_ner_corpus&quot;</span><span class="p">,</span>                    <span class="c1"># dataset = dataset_name</span>
    <span class="n">annotation_scheme</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">,</span>
    <span class="n">prune_ratio_train</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>                           <span class="c1"># for testing</span>
    <span class="n">prune_ratio_val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">prune_ratio_test</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">train_on_val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">train_on_test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">checkpoints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">logging_level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
    <span class="n">multiple_runs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">max_epochs</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
    <span class="n">early_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
    <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="n">lr_warmup_epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">lr_num_cycles</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">lr_cooldown_restarts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">lr_cooldown_epochs</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">max_seq_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">lr_max</span><span class="o">=</span><span class="mf">2e-5</span><span class="p">,</span>
    <span class="n">lr_schedule</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
</details>
</li>
</ul>
<p>The parameters can be divided into 4 <strong>parameter groups</strong>:</p>
<ol>
<li>Dataset</li>
<li>Model</li>
<li>Settings</li>
<li>Hyperparameters</li>
</ol>
<p>In the following, we will go through the different parameters step by step to see what they mean.</p>
<p><strong>1. Dataset</strong></p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Mandatory</th>
<th>Default Value</th>
<th>Type</th>
<th>Values</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>dataset_name</td>
<td>Yes</td>
<td>---</td>
<td>str</td>
<td>e.g. conll2003</td>
<td>key = dataset can be used instead</td>
</tr>
<tr>
<td>annotation_scheme</td>
<td>No</td>
<td>auto</td>
<td>str</td>
<td>auto, plain, bio, bilou</td>
<td>specify annotation scheme (e.g. <a href="https://en.wikipedia.org/wiki/Inside%E2%80%93outside%E2%80%93beginning_(tagging)">BIO</a>). auto means it is inferred from data</td>
</tr>
<tr>
<td>prune_ratio_train</td>
<td>No</td>
<td>1.0</td>
<td>float</td>
<td>0.0 - 1.0</td>
<td>fraction of train dataset to be used</td>
</tr>
<tr>
<td>prune_ratio_val</td>
<td>No</td>
<td>1.0</td>
<td>float</td>
<td>0.0 - 1.0</td>
<td>fraction of val   dataset to be used</td>
</tr>
<tr>
<td>prune_ratio_test</td>
<td>No</td>
<td>1.0</td>
<td>float</td>
<td>0.0 - 1.0</td>
<td>fraction of test  dataset to be used</td>
</tr>
<tr>
<td>train_on_val</td>
<td>No</td>
<td>False</td>
<td>bool</td>
<td>True, False</td>
<td>whether to train additionally on validation dataset</td>
</tr>
<tr>
<td>train_on_test</td>
<td>No</td>
<td>False</td>
<td>bool</td>
<td>True, False</td>
<td>whether to train additionally on test dataset</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>Example: static experiment configuration file with parameters (Dataset)</summary>
<div class="highlight"><pre><span></span><code><span class="gh"># my_experiment.ini</span>
<span class="gh"># ..</span>

[dataset]
dataset_name = swedish_ner_corpus
annotation_scheme = plain
prune_ratio_train = 0.1  # for testing
prune_ratio_val = 1.0
prune_ratio_test = 1.0
train_on_val = False
train_on_test = False
</code></pre></div>
</details>
<p><strong>2. Model</strong></p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Mandatory</th>
<th>Default Value</th>
<th>Type</th>
<th>Values</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>pretrained_model_name</td>
<td>Yes</td>
<td>---</td>
<td>str</td>
<td>e.g. af-ai-center/bert-base-swedish-uncased</td>
<td>key = model can be used instead</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>Example: static experiment configuration file with parameters (Model)</summary>
<div class="highlight"><pre><span></span><code><span class="gh"># my_experiment.ini</span>
<span class="gh"># ..</span>

[model]
pretrained_model_name = af-ai-center/bert-base-swedish-uncased
</code></pre></div>
</details>
<p><strong>3. Settings</strong></p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Mandatory</th>
<th>Default Value</th>
<th>Type</th>
<th>Values</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>checkpoints</td>
<td>No</td>
<td>True</td>
<td>bool</td>
<td>True, False</td>
<td>whether to save model checkpoints</td>
</tr>
<tr>
<td>logging_level</td>
<td>No</td>
<td>info</td>
<td>str</td>
<td>info, debug</td>
<td>choose <a href="https://docs.python.org/3/library/logging.html#levels">logging level</a>, debug is more verbose</td>
</tr>
<tr>
<td>multiple_runs</td>
<td>No</td>
<td>1</td>
<td>int</td>
<td>1+</td>
<td>choose how often each hyperparameter run is executed (to control for statistical uncertainties)</td>
</tr>
<tr>
<td>seed</td>
<td>No</td>
<td>42</td>
<td>int</td>
<td>1+</td>
<td>for reproducibility. multiple runs get assigned different seeds.</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>Example: static experiment configuration file with parameters (Settings)</summary>
<div class="highlight"><pre><span></span><code><span class="gh"># my_experiment.ini</span>
<span class="gh"># ..</span>

[settings]
checkpoints = True
logging_level = info
multiple_runs = 1
seed = 42
</code></pre></div>
</details>
<p><strong>4. Hyperparameters</strong></p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Mandatory</th>
<th>Default Value</th>
<th>Type</th>
<th>Values</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>batch_size</td>
<td>No</td>
<td>16</td>
<td>int</td>
<td>e.g. 16, 32, 64</td>
<td>number of training samples in one batch</td>
</tr>
<tr>
<td>max_seq_length</td>
<td>No</td>
<td>128</td>
<td>int</td>
<td>e.g. 64, 128, 256</td>
<td>maximum sequence length used for model's input data</td>
</tr>
<tr>
<td>max_epochs</td>
<td>No</td>
<td>250</td>
<td>int</td>
<td>1+</td>
<td>(maximum) amount of training epochs</td>
</tr>
<tr>
<td>early_stopping</td>
<td>No</td>
<td>True</td>
<td>bool</td>
<td>True, False</td>
<td>whether to use early stopping</td>
</tr>
<tr>
<td>monitor</td>
<td>No</td>
<td>val_loss</td>
<td>str</td>
<td>val_loss, val_acc</td>
<td>if early stopping is True: metric to monitor (acc = accuracy)</td>
</tr>
<tr>
<td>min_delta</td>
<td>No</td>
<td>0.0</td>
<td>float</td>
<td>0.0+</td>
<td>if early stopping is True: minimum amount of improvement (w.r.t. monitored metric) required to continue training</td>
</tr>
<tr>
<td>patience</td>
<td>No</td>
<td>0</td>
<td>int</td>
<td>0+</td>
<td>if early stopping is True: number of epochs to wait for improvement w.r.t. monitored metric until training is stopped</td>
</tr>
<tr>
<td>mode</td>
<td>No</td>
<td>min</td>
<td>str</td>
<td>min, max</td>
<td>if early stopping is True: whether the optimum for the monitored metric is the minimum (val_loss) or maximum (val_acc) value</td>
</tr>
<tr>
<td>lr_warmup_epochs</td>
<td>No</td>
<td>2</td>
<td>int</td>
<td>0+</td>
<td>number of epochs to linearly increase the learning rate during the warm-up phase, gets translated to <a href="https://huggingface.co/transformers/main_classes/optimizer_schedules.html#transformers.get_scheduler">num_warmup_steps</a></td>
</tr>
<tr>
<td>lr_max</td>
<td>No</td>
<td>2e-5</td>
<td>float</td>
<td>e.g. 2e-5, 3e-5</td>
<td>maximum learning rate (after warm-up) for <a href="https://huggingface.co/transformers/main_classes/optimizer_schedules.html#transformers.AdamW">AdamW optimizer</a></td>
</tr>
<tr>
<td>lr_schedule</td>
<td>No</td>
<td>constant</td>
<td>str</td>
<td>constant, linear, cosine, cosine_with_hard_restarts, hybrid</td>
<td><a href="https://huggingface.co/transformers/main_classes/optimizer_schedules.html#schedules">Learning Rate Schedule</a>, i.e. how to vary the learning rate (after warm-up). hybrid = constant + linear cool-down.</td>
</tr>
<tr>
<td>lr_num_cycles</td>
<td>No</td>
<td>4</td>
<td>int</td>
<td>1+</td>
<td>num_cycles for <a href="https://huggingface.co/transformers/main_classes/optimizer_schedules.html#transformers.get_cosine_schedule_with_warmup">lr_schedule = cosine</a> or <a href="https://huggingface.co/transformers/main_classes/optimizer_schedules.html#transformers.get_cosine_with_hard_restarts_schedule_with_warmup">lr_schedule = cosine_with_hard_restarts</a></td>
</tr>
<tr>
<td>lr_cooldown_restarts</td>
<td>No</td>
<td>True</td>
<td>bool</td>
<td>True, False</td>
<td>if early stopping is True: whether to restart normal training if monitored metric improves during cool-down phase</td>
</tr>
<tr>
<td>lr_cooldown_epochs</td>
<td>No</td>
<td>7</td>
<td>int</td>
<td>0+</td>
<td>if early stopping is True or lr_schedule == hybrid: number of epochs to linearly decrease the learning rate during the cool-down phase</td>
</tr>
</tbody>
</table>
<details class="example">
<summary>Example: static experiment configuration file with parameters (Hyperparameters)</summary>
<div class="highlight"><pre><span></span><code><span class="gh"># my_experiment.ini</span>
<span class="gh"># ..</span>

[hparams]
max_epochs = 250
early_stopping = True
monitor = val_loss
min_delta = 0.0
patience = 0
mode = min
lr_warmup_epochs = 2
lr_num_cycles = 4
lr_cooldown_restarts = True
lr_cooldown_epochs = 7

[runA]
batch_size = 16
max_seq_length = 128
lr_max = 2e-5
lr_schedule = constant
</code></pre></div>
</details>
<hr />
<h3 id="presets">Presets</h3>
<p>In addition to the manual specification of the parameters discussed above, 
the dynamic experiment definition allows for the use of several hyperparameter <a href="./#presets">presets</a>.
They can be specified using the <code>from_preset</code> argument in <a href="../../python_api/experiment">Experiment()</a> like so:</p>
<details class="note">
<summary>define experiment dynamically using preset</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Python</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">experiment</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="s2">&quot;&lt;experiment_name&gt;&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;&lt;model_name&gt;&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;&lt;dataset_name&gt;&quot;</span><span class="p">,</span> <span class="n">from_preset</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
</details>
<p>In the following, we list the different presets together with the <a href="#parameters">Hyperparameters</a> that they entail:</p>
<ul>
<li>
<p><code>from_preset = adaptive</code></p>
<p>Adaptive fine-tuning (introduced in <a href="https://arxiv.org/abs/2202.02617">this paper</a>) is a method that automatically trains for a near-optimal number of epochs.
It is used by default in <strong>nerblackbox</strong>.</p>
<details class="note">
<summary>adaptive fine-tuning preset</summary>
<div class="highlight"><pre><span></span><code>[hparams]
max_epochs = 250
early_stopping = True
monitor = val_loss
min_delta = 0.0
patience = 0
mode = min
lr_warmup_epochs = 2
lr_schedule = constant
lr_cooldown_epochs = 7
</code></pre></div>
</details>
</li>
<li>
<p><code>from_preset = original</code></p>
<p>Original fine-tuning uses the hyperparameters from the <a href="https://arxiv.org/abs/1810.04805">original BERT paper</a>.
The hyperparameters are suitable for large datasets.</p>
<details class="note">
<summary>original fine-tuning preset</summary>
<div class="highlight"><pre><span></span><code>[hparams]
max_epochs = 5
early_stopping = False
lr_warmup_epochs = 2
lr_schedule = linear
</code></pre></div>
</details>
</li>
<li>
<p><code>from_preset = stable</code></p>
<p>Stable fine-tuning is a method based on <a href="https://arxiv.org/abs/2006.04884">this paper</a>.
It is suitable for both small and large datasets.</p>
<details class="note">
<summary>stable fine-tuning preset</summary>
<div class="highlight"><pre><span></span><code>[hparams]
max_epochs = 20
early_stopping = False
lr_warmup_epochs = 2
lr_schedule = linear
</code></pre></div>
</details>
</li>
</ul>
<hr />
<h3 id="hyperparameter-search">Hyperparameter Search</h3>
<p>A hyperparameter grid search can easily be conducted as part of an experiment (currently only using the <a href="#define-an-experiment">static definition</a>).
The hyperparameters one wants to vary are to be specified in special sections <code>[runA]</code>, <code>[runB]</code> etc. in the experiment configuration file.</p>
<details class="example">
<summary>Example: Hyperparameter Search</summary>
<p><div class="highlight"><pre><span></span><code><span class="gh"># my_experiment.ini</span>
<span class="gh"># ..</span>

[runA]
batch_size = 16
max_seq_length = 128
lr_max = 2e-5
lr_schedule = constant

[runB]
batch_size = 32
max_seq_length = 64
lr_max = 3e-5
lr_schedule = cosine
</code></pre></div>
This creates <strong>2 hyperparameter runs</strong> (<code>runA</code> &amp; <code>runB</code>). Each hyperparameter run is executed <code>multiple_runs</code> times (see <a href="#parameters">Parameters</a>).</p>
</details>
<hr />
<h3 id="multiple-seeds">Multiple Seeds</h3>
<p>The results of a fine-tuning run depend on the employed random seed, see e.g. <a href="https://arxiv.org/abs/2202.02617">this paper</a> for a discussion.
One may conduct multiple runs with different seeds that are otherwise identical, in order to</p>
<ul>
<li>
<p>get control over the uncertainties (see <a href="#detailed-results">Detailed Results</a>)</p>
</li>
<li>
<p>get an improved model performance</p>
</li>
</ul>
<p>Multiple runs can easily be specified in the experiment configuration.</p>
<details class="example">
<summary>Example: Settings / Multiple Runs</summary>
<div class="highlight"><pre><span></span><code><span class="gh"># my_experiment.ini</span>
<span class="gh"># ..</span>

[settings]
multiple_runs = 3
seed = 42
</code></pre></div>
<p>This creates 3 runs with seeds 43, 44 and 45.</p>
</details>
<hr />
<h3 id="detailed-results">Detailed Results</h3>
<p>In addition to the <a href="#main-results">Main Results</a>, one may have a look at much more detailed results of an experiment
using <code>mlflow</code> or <code>tensorboard</code>.</p>
<details class="note">
<summary>Detailed Results</summary>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Python</label><label for="__tabbed_7_2">CLI</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">Store</span><span class="o">.</span><span class="n">mlflow</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>       <span class="c1"># + enter http://localhost:5000 in your browser</span>
<span class="n">Store</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>  <span class="c1"># + enter http://localhost:6006 in your browser</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nerbb<span class="w"> </span>mlflow<span class="w">         </span><span class="c1"># + enter http://localhost:5000 in your browser</span>
nerbb<span class="w"> </span>tensorboard<span class="w">    </span><span class="c1"># + enter http://localhost:6006 in your browser</span>
</code></pre></div>
</div>
</div>
</div>
<p>Python: The underlying processes can be stopped using
<a href="../../python_api/store/#nerblackbox.api.store.Store.mlflow"><code>Store.mlflow("stop")</code></a>
and <a href="../../python_api/store/#nerblackbox.api.store.Store.tensorboard"><code>Store.tensorboard("stop")</code></a>.</p>
</details>
<ul>
<li>
<p><code>mlflow</code> displays precision, recall and f1 score for every single class,
as well the respective micro- and macro-averages over all classes, both on the token and entity level.</p>
<p>The following excerpt shows</p>
<ul>
<li>
<p>the micro- and macro-averages of the recall on the entity level</p>
</li>
<li>
<p>precision, recall and f1 score for the LOC(ation) class on the token level</p>
</li>
</ul>
<p><img alt="mlflow screenshot detailed results" src="../images/mlflow_1.png" /></p>
<p>In addition, one has access to the log file and the confusion matrices (token and entity level) of the model predictions on the test set.
A small excerpt is shown below:</p>
<p><img alt="mlflow screenshot confusion matrix" src="../images/mlflow_2.png" /></p>
</li>
<li>
<p><code>tensorboard</code> shows the learning curves of important metrics like the loss and the f1 score.</p>
<p>A small excerpt is shown below:</p>
<p><img alt="tensorboard screenshot example" src="../images/tensorboard.png" /></p>
</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 - 2023 Felix Stollenwerk
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "toc.integrate"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.b78d2936.min.js"></script>
      
    
  </body>
</html>